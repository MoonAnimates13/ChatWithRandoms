<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ChatWithRandoms.com</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, Arial, sans-serif;
      background: #111;
      color: #eee;
    }
    #container {
      width: 100%;
      max-width: 720px;
      height: 100vh;
      margin: 0 auto;
      background: #222;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #name-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 20px;
      gap: 12px;
    }
    #chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      display: none;
      overflow: hidden;
    }
    #header {
      background: #1a1a1a;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #333;
      flex-shrink: 0;
      font-size: 14px;
      flex-wrap: wrap;
      gap: 8px;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      margin: 0;
      background: #000;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }
    #messages::-webkit-scrollbar { width: 8px; }
    #messages::-webkit-scrollbar-track { background: transparent; }
    #messages::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    #messages li {
      display: flex;
      align-items: flex-start;
      margin: 12px 0;
      padding: 10px 14px;
      border-radius: 16px;
      background: #333;
      max-width: 85%;
      word-wrap: break-word;
      line-height: 1.4;
    }
    #messages li.me {
      margin-left: auto;
      background: #007bff;
      color: white;
    }
    #messages .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 12px;
      object-fit: cover;
      flex-shrink: 0;
      border: 2px solid #555;
    }
    #messages .content { flex: 1; }
    #messages .username { font-weight: bold; margin-right: 6px; }
    #messages img.chat-img { max-width: 280px; border-radius: 10px; margin-top: 8px; display: block; }
    #messages .delete-btn {
      background: none;
      border: none;
      color: #ff7777;
      font-size: 22px;
      cursor: pointer;
      margin-left: 10px;
      opacity: 0.7;
    }
    #messages .delete-btn:hover { opacity: 1; }
    #messages .system {
      margin: 20px auto;
      padding: 10px 20px;
      background: #444;
      color: #ccc;
      font-style: italic;
      border-radius: 20px;
      text-align: center;
      font-size: 14px;
    }
    #input-area {
      display: flex;
      padding: 12px 16px;
      background: #1a1a1a;
      border-top: 1px solid #333;
      gap: 10px;
      flex-shrink: 0;
      position: relative;
    }
    #input {
      flex: 1;
      padding: 14px 18px;
      border: none;
      border-radius: 30px;
      background: #2a2a2a;
      color: #eee;
      font-size: 16px;
    }
    #input:focus { outline: none; background: #333; }
    button {
      padding: 14px 20px;
      background: #007bff;
      border: none;
      color: white;
      cursor: pointer;
      border-radius: 30px;
      font-size: 15px;
      white-space: nowrap;
    }
    #image-btn { background: #444; }
    #clear-chat-btn { background: #d32f2f; display: none; }
    #chaos-toggle-btn { background: #ff5722; display: none; }
    #tempo-toggle-btn { background: #9c27b0; display: none; }
    #ban-btn { background: #d32f2f; display: none; padding: 10px 16px; }
    #unban-btn { background: #4caf50; display: none; padding: 10px 16px; }
    #reset-profile { background: #555; font-size: 13px; padding: 8px 14px; }
    #online { color: #4caf50; font-weight: bold; }
    input[type="text"] {
      padding: 14px 18px;
      border: none;
      border-radius: 30px;
      font-size: 16px;
      background: #333;
      color: white;
    }
    #ban-username-input {
      padding: 8px 14px;
      border-radius: 20px;
      background: #333;
      color: white;
      border: none;
      min-width: 180px;
      display: none;
    }
    #spam-toast {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 87, 34, 0.9);
      color: white;
      padding: 10px 24px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: bold;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      z-index: 100;
      white-space: nowrap;
    }
    #spam-toast.visible { opacity: 1; }
    #chaos-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 9999;
      overflow: hidden;
      display: none;
    }
    #chaos-overlay.active { display: block; }
    .krater {
      position: absolute;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      filter: drop-shadow(0 0 30px #00ff9d) drop-shadow(0 0 60px #ff00ff);
      opacity: 0.92;
      pointer-events: none;
    }
    @keyframes kraterFly {
      0% { transform: translate(-50%, -50%) rotate(0deg) scale(1); opacity: 0.92; }
      100% { transform: translate(var(--dx), var(--dy)) rotate(var(--rotate-end, 2160deg)) scale(0.15); opacity: 0; }
    }
    #chaos-overlay.strobe {
      animation: krater-strobe 0.04s infinite alternate;
    }
    @keyframes krater-strobe {
      0% { background: rgba(255,0,255,0.5); filter: invert(1) brightness(1.6); }
      100% { background: rgba(0,255,0,0.5); filter: invert(0) brightness(0.7); }
    }
    .shake {
      animation: krater-shake 0.03s infinite linear;
    }
    @keyframes krater-shake {
      0%, 100% { transform: translate(0,0) rotate(0deg) scale(1); }
      10% { transform: translate(60px,-60px) rotate(18deg) scale(1.3); }
      30% { transform: translate(-60px,60px) rotate(-18deg) scale(0.7); }
      50% { transform: translate(80px, -40px) rotate(25deg) scale(1.4); }
      70% { transform: translate(-80px,40px) rotate(-25deg) scale(0.6); }
      90% { transform: translate(40px, -80px) rotate(15deg) scale(1.2); }
    }
    #tempo-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.85);
      z-index: 10000;
      display: none;
      justify-content: center;
      align-items: center;
      pointer-events: none;
    }
    #tempo-overlay.active { display: flex; }
    #tempo-img {
      max-width: 80%;
      max-height: 80%;
      border-radius: 20px;
      box-shadow: 0 0 60px #ff0000;
      animation: explodeTempo 5s forwards;
    }
    @keyframes explodeTempo {
      0% { transform: scale(1) rotate(0deg); opacity: 1; }
      80% { transform: scale(2.5) rotate(720deg); opacity: 1; }
      100% { transform: scale(5) rotate(1440deg); opacity: 0; }
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="name-screen">
      <h1>ChatWithRandoms.com</h1>
      <p>Enter your name + avatar URL (everyone will see it)</p>
      <input id="name" type="text" placeholder="Your name..." />
      <input id="avatar-url" type="text" placeholder="https://i.imgur.com/abc123.jpg (optional)" />
      <button onclick="joinOrAuto()">Join / Continue</button>
    </div>
    <div id="chat">
      <div id="header">
        <div id="online">Online: 0</div>
        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
          <button id="clear-chat-btn" onclick="clearAllChats()">Clear All Chats</button>
          <button id="chaos-toggle-btn" onclick="toggleChaos()">Toggle Chaos</button>
          <button id="tempo-toggle-btn" onclick="toggleTempo()">Tempo Meme</button>
          <input id="ban-username-input" type="text" placeholder="Username to ban/unban" />
          <button id="ban-btn" onclick="adminBan()">Ban User</button>
          <button id="unban-btn" onclick="adminUnban()">Unban User</button>
          <button id="reset-profile" onclick="resetProfile()">Change Profile</button>
        </div>
      </div>
      <ul id="messages"></ul>
      <div id="input-area">
        <input id="input" autocomplete="off" placeholder="Type a message..." />
        <input type="file" id="image-upload" accept="image/*" style="display:none;" />
        <button id="image-btn" onclick="document.getElementById('image-upload').click()">Photo</button>
        <button onclick="sendMessage()">Send</button>
        <div id="spam-toast">Don't spam!</div>
      </div>
    </div>
  </div>
  <div id="chaos-overlay"></div>
  <div id="tempo-overlay">
    <img id="tempo-img" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRPsny6wHtHWi3m5WQqxT8TabGwB-e6NAUteA&s" alt="Not quite my tempo">
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const socket = io('https://chat-randoms-backend.onrender.com');
    const ADMIN_SECRET = 'Admin-87a6d987asdt8yaguksdghfas7d!';
    let myUsername = localStorage.getItem('chatUsername') || '';
    let myAvatarURL = localStorage.getItem('chatAvatarURL') || '';
    const nameScreen = document.getElementById('name-screen');
    const chat = document.getElementById('chat');
    const nameInput = document.getElementById('name');
    const avatarUrlInput = document.getElementById('avatar-url');
    const messages = document.getElementById('messages');
    const input = document.getElementById('input');
    const online = document.getElementById('online');
    const imageUpload = document.getElementById('image-upload');
    const clearChatBtn = document.getElementById('clear-chat-btn');
    const chaosToggleBtn = document.getElementById('chaos-toggle-btn');
    const tempoToggleBtn = document.getElementById('tempo-toggle-btn');
    const banInput = document.getElementById('ban-username-input');
    const banBtn = document.getElementById('ban-btn');
    const unbanBtn = document.getElementById('unban-btn');
    const spamToast = document.getElementById('spam-toast');
    const chaosOverlay = document.getElementById('chaos-overlay');
    const tempoOverlay = document.getElementById('tempo-overlay');
    const container = document.getElementById('container');
    let chaosActive = false;
    let chaosLevel = 1;
    let kraterInterval;
    let tempoActive = false;
    const tempoAudio = new Audio('https://www.myinstants.com/media/sounds/not-quite-my-tempo.mp3');
    tempoAudio.volume = 1.0;
    tempoAudio.playbackRate = 1.0;

    if (myUsername) autoJoin();

    function autoJoin() {
      socket.emit('join', { name: myUsername, avatarURL: myAvatarURL });
      nameScreen.style.display = 'none';
      chat.style.display = 'flex';
      checkAdmin();
    }

    function joinOrAuto() {
      const name = nameInput.value.trim();
      if (!name) return alert('Name required!');
      myUsername = name;
      myAvatarURL = avatarUrlInput.value.trim() || '';
      localStorage.setItem('chatUsername', myUsername);
      if (myAvatarURL) localStorage.setItem('chatAvatarURL', myAvatarURL);
      socket.emit('join', { name: myUsername, avatarURL: myAvatarURL });
      nameScreen.style.display = 'none';
      chat.style.display = 'flex';
      checkAdmin();
    }

    function checkAdmin() {
      const isAdmin = (myUsername === ADMIN_SECRET);
      clearChatBtn.style.display = isAdmin ? 'inline-block' : 'none';
      chaosToggleBtn.style.display = isAdmin ? 'inline-block' : 'none';
      tempoToggleBtn.style.display = isAdmin ? 'inline-block' : 'none';
      banBtn.style.display = isAdmin ? 'inline-block' : 'none';
      unbanBtn.style.display = isAdmin ? 'inline-block' : 'none';
      banInput.style.display = isAdmin ? 'inline-block' : 'none';
    }

    function clearAllChats() {
      if (confirm('Clear chat for EVERYONE right now?')) socket.emit('admin-clear-chat');
    }

    socket.on('clear-chat', () => {
      messages.innerHTML = '';
      addSystemMessage('Chat cleared by admin');
      messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
    });

    function resetProfile() {
      localStorage.removeItem('chatUsername');
      localStorage.removeItem('chatAvatarURL');
      location.reload();
    }

    function showSpamWarning() {
      spamToast.classList.add('visible');
      setTimeout(() => spamToast.classList.remove('visible'), 2000);
    }

    function sendMessage() {
      const msg = input.value.trim();
      if (!msg) return;
      socket.emit('chat message', msg, (success) => {
        if (success) input.value = '';
        else showSpamWarning();
      });
    }

    imageUpload.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file || file.size > 2*1024*1024) return alert('Max 2MB');
      const reader = new FileReader();
      reader.onload = ev => {
        socket.emit('image', { buffer: ev.target.result, mime: file.type }, (success) => {
          if (!success) showSpamWarning();
        });
      };
      reader.readAsArrayBuffer(file);
    });

    input.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

    function addSystemMessage(text) {
      const li = document.createElement('li');
      li.className = 'system';
      li.textContent = text;
      messages.appendChild(li);
    }

    function shouldAutoScroll() {
      return (messages.scrollHeight - messages.scrollTop - messages.clientHeight) < 500;
    }

    function appendMessage(data, isHistory = false) {
      const li = document.createElement('li');
      if (data.username === myUsername) li.classList.add('me');
      if (data.system) {
        li.className = 'system';
        li.textContent = data.text;
      } else {
        const avatar = document.createElement('img');
        avatar.className = 'avatar';
        avatar.src = data.avatarURL || `https://via.placeholder.com/40/333/fff?text=${data.username[0]||'?'}`;
        avatar.onerror = () => avatar.src = 'https://via.placeholder.com/40/333/fff?text=?';
        li.appendChild(avatar);
        const content = document.createElement('div');
        content.className = 'content';
        content.innerHTML = `<span class="username">${data.username}</span> `;
        if (data.isImage) {
          const img = document.createElement('img');
          img.className = 'chat-img';
          img.src = `data:${data.mime};base64,${btoa(String.fromCharCode(...new Uint8Array(data.image)))}`;
          content.appendChild(img);
        } else {
          content.appendChild(document.createTextNode(data.text));
        }
        li.appendChild(content);
        if (data.username === myUsername && !data.isImage) {
          const del = document.createElement('button');
          del.className = 'delete-btn';
          del.textContent = 'Ã—';
          del.onclick = () => li.remove();
          li.appendChild(del);
        }
      }
      messages.appendChild(li);
      if (!isHistory || shouldAutoScroll()) {
        setTimeout(() => messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' }), isHistory ? 50 : 0);
      }
    }

    socket.on('message', appendMessage);
    socket.on('history', h => h.forEach(m => appendMessage(m, true)));
    socket.on('online', c => online.textContent = `Online: ${c}`);

    function toggleChaos() {
      chaosActive = !chaosActive;
      chaosToggleBtn.textContent = chaosActive ? 'STOP CHAOS' : 'Toggle Chaos';
      socket.emit('admin-toggle-chaos', chaosActive);
      if (chaosActive) {
        chaosOverlay.classList.add('active', 'strobe');
        container.classList.add('shake');
        chaosLevel = 1;
        spawnKraters();
      } else {
        chaosOverlay.classList.remove('active', 'strobe');
        container.classList.remove('shake');
        chaosOverlay.innerHTML = '';
        clearInterval(kraterInterval);
      }
    }

    function spawnKraters() {
      chaosOverlay.innerHTML = '';

      const kraterImages = [
        'https://c.tenor.com/OacC9jUhkgQAAAAC/tenor.gif'
      ];

      const kraterCount = Math.min(40 + chaosLevel * 4, 80);

      for (let i = 0; i < kraterCount; i++) {
        const krater = document.createElement('div');
        krater.className = 'krater';

        const size = 50 + Math.random() * 300;
        krater.style.width = `${size}px`;
        krater.style.height = `${size}px`;

        const randomImg = kraterImages[Math.floor(Math.random() * kraterImages.length)];
        krater.style.backgroundImage = `url('${randomImg}')`;

        const side = Math.floor(Math.random() * 8);
        let startX, startY, dx, dy;
        if      (side === 0) { startX = Math.random()*180; startY = -80; dx = (Math.random()-0.5)*1200; dy = 300 + Math.random()*800; }
        else if (side === 1) { startX = 180; startY = Math.random()*180; dx = -300 - Math.random()*800; dy = (Math.random()-0.5)*1200; }
        else if (side === 2) { startX = Math.random()*180; startY = 180; dx = (Math.random()-0.5)*1200; dy = -300 - Math.random()*800; }
        else if (side === 3) { startX = -80; startY = Math.random()*180; dx = 300 + Math.random()*800; dy = (Math.random()-0.5)*1200; }
        else if (side === 4) { startX = -80; startY = -80; dx = (Math.random()-0.5)*1000; dy = (Math.random()-0.5)*1000; }
        else if (side === 5) { startX = 180; startY = -80; dx = -(Math.random()*1000 + 200); dy = (Math.random()*1000 + 200); }
        else if (side === 6) { startX = 180; startY = 180; dx = -(Math.random()*1000 + 200); dy = -(Math.random()*1000 + 200); }
        else                 { startX = -80; startY = 180; dx = (Math.random()*1000 + 200); dy = -(Math.random()*1000 + 200); }

        krater.style.left = `${startX}vw`;
        krater.style.top  = `${startY}vh`;
        krater.style.setProperty('--dx', `${dx}vw`);
        krater.style.setProperty('--dy', `${dy}vh`);

        const baseDuration = 1.3 - (chaosLevel * 0.065);
        const duration = Math.max(0.20, baseDuration);
        const direction = Math.random() > 0.5 ? 2160 : -2160;
        krater.style.animation = `kraterFly ${duration}s ease-in-out forwards`;
        krater.style.setProperty('--rotate-end', `${direction}deg`);
        krater.style.animationDelay = `${Math.random() * 0.4}s`;

        const glowIntensity = Math.min(chaosLevel * 8, 120);
        krater.style.filter = `drop-shadow(0 0 ${glowIntensity}px #00ff9d) drop-shadow(0 0 ${glowIntensity*1.5}px #ff00ff)`;

        chaosOverlay.appendChild(krater);
      }

      const nextSpawnMs = Math.max(200, 900 - (chaosLevel * 60));
      kraterInterval = setTimeout(spawnKraters, nextSpawnMs);

      chaosLevel = Math.min(chaosLevel + 1.5, 25);
    }

    socket.on('chaos-toggle', (enable) => {
      chaosActive = enable;
      chaosToggleBtn.textContent = chaosActive ? 'STOP CHAOS' : 'Toggle Chaos';
      if (chaosActive) {
        chaosOverlay.classList.add('active', 'strobe');
        container.classList.add('shake');
        chaosLevel = 1;
        spawnKraters();
      } else {
        chaosOverlay.classList.remove('active', 'strobe');
        container.classList.remove('shake');
        chaosOverlay.innerHTML = '';
        clearInterval(kraterInterval);
      }
    });

    function toggleTempo() {
      tempoActive = !tempoActive;
      tempoToggleBtn.textContent = tempoActive ? 'Stop Tempo' : 'Tempo Meme';
      socket.emit('admin-toggle-tempo', tempoActive);
      if (tempoActive) {
        tempoOverlay.style.display = 'flex';
        tempoAudio.volume = 1.0;
        tempoAudio.playbackRate = 1.0;
        tempoAudio.currentTime = 0;
        tempoAudio.play().catch(() => console.log('Audio blocked - user interaction needed'));
        setTimeout(() => {
          tempoOverlay.style.animation = 'explodeTempo 1.5s forwards';
          setTimeout(() => {
            tempoOverlay.style.display = 'none';
            tempoOverlay.style.animation = '';
            tempoActive = false;
            tempoToggleBtn.textContent = 'Tempo Meme';
          }, 1500);
        }, 3500);
      } else {
        tempoOverlay.style.display = 'none';
        tempoAudio.pause();
        tempoOverlay.style.animation = '';
      }
    }

    socket.on('tempo-toggle', (enable) => {
      tempoActive = enable;
      tempoToggleBtn.textContent = tempoActive ? 'Stop Tempo' : 'Tempo Meme';
      if (tempoActive) {
        tempoOverlay.style.display = 'flex';
        tempoAudio.volume = 1.0;
        tempoAudio.playbackRate = 1.0;
        tempoAudio.currentTime = 0;
        tempoAudio.play().catch(() => {});
        setTimeout(() => {
          tempoOverlay.style.animation = 'explodeTempo 1.5s forwards';
          setTimeout(() => {
            tempoOverlay.style.display = 'none';
            tempoOverlay.style.animation = '';
            tempoActive = false;
            tempoToggleBtn.textContent = 'Tempo Meme';
          }, 1500);
        }, 3500);
      } else {
        tempoOverlay.style.display = 'none';
        tempoAudio.pause();
        tempoOverlay.style.animation = '';
      }
    });

    // Ban / Unban functions
    function adminBan() {
      const target = banInput.value.trim();
      if (!target) return alert('Enter a username to ban!');
      socket.emit('admin-ban-user', target);
      banInput.value = '';
    }

    function adminUnban() {
      const target = banInput.value.trim();
      if (!target) return alert('Enter a username to unban!');
      socket.emit('admin-unban-user', target);
      banInput.value = '';
    }

    socket.on('banned', (data) => {
      alert(`You are banned: ${data.reason || 'No reason provided.'}`);
      document.body.innerHTML = `<div style="color:red; text-align:center; margin-top:40vh; font-size:32px;">
        BANNED<br><br>${data.reason || 'You have been banned from this chat.'}
      </div>`;
    });
  </script>
</body>
</html>
