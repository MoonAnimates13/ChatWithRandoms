<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ChatWithRandoms.com</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, Arial, sans-serif;
      background: #111;
      color: #eee;
    }
    #container {
      width: 100%;
      max-width: 720px;
      height: 100vh;
      margin: 0 auto;
      background: #222;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #name-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 20px;
      gap: 12px;
    }
    #chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      display: none;
      overflow: hidden;
    }
    #header {
      background: #1a1a1a;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #333;
      flex-shrink: 0;
      font-size: 14px;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      margin: 0;
      background: #000;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }
    #messages::-webkit-scrollbar { width: 8px; }
    #messages::-webkit-scrollbar-track { background: transparent; }
    #messages::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    #messages li {
      display: flex;
      align-items: flex-start;
      margin: 12px 0;
      padding: 10px 14px;
      border-radius: 16px;
      background: #333;
      max-width: 85%;
      word-wrap: break-word;
      line-height: 1.4;
    }
    #messages li.me {
      margin-left: auto;
      background: #007bff;
      color: white;
    }
    #messages .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 12px;
      object-fit: cover;
      flex-shrink: 0;
      border: 2px solid #555;
    }
    #messages .content { flex: 1; }
    #messages .username { font-weight: bold; margin-right: 6px; }
    #messages img.chat-img { max-width: 280px; border-radius: 10px; margin-top: 8px; display: block; }
    #messages .delete-btn {
      background: none;
      border: none;
      color: #ff7777;
      font-size: 22px;
      cursor: pointer;
      margin-left: 10px;
      opacity: 0.7;
    }
    #messages .delete-btn:hover { opacity: 1; }
    #messages .system {
      margin: 20px auto;
      padding: 10px 20px;
      background: #444;
      color: #ccc;
      font-style: italic;
      border-radius: 20px;
      text-align: center;
      font-size: 14px;
    }
    #input-area {
      display: flex;
      padding: 12px 16px;
      background: #1a1a1a;
      border-top: 1px solid #333;
      gap: 10px;
      flex-shrink: 0;
      position: relative;
    }
    #input {
      flex: 1;
      padding: 14px 18px;
      border: none;
      border-radius: 30px;
      background: #2a2a2a;
      color: #eee;
      font-size: 16px;
    }
    #input:focus { outline: none; background: #333; }
    button {
      padding: 14px 20px;
      background: #007bff;
      border: none;
      color: white;
      cursor: pointer;
      border-radius: 30px;
      font-size: 15px;
    }
    #image-btn { background: #444; }
    #clear-chat-btn { background: #d32f2f; display: none; }
    #reset-profile { background: #555; font-size: 13px; padding: 8px 14px; }
    #online { color: #4caf50; font-weight: bold; }
    input[type="text"] {
      padding: 14px 18px;
      border: none;
      border-radius: 30px;
      width: 300px;
      font-size: 16px;
      background: #333;
      color: white;
    }
    #spam-toast {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 87, 34, 0.9);
      color: white;
      padding: 10px 24px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: bold;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      z-index: 100;
      white-space: nowrap;
    }
    #spam-toast.visible {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="name-screen">
      <h1>ChatWithRandoms.com</h1>
      <p>Enter your name + avatar URL (everyone will see it)</p>
      <input id="name" type="text" placeholder="Your name..." />
      <input id="avatar-url" type="text" placeholder="https://i.imgur.com/abc123.jpg (optional)" />
      <button onclick="joinOrAuto()">Join / Continue</button>
    </div>

    <div id="chat">
      <div id="header">
        <div id="online">Online: 0</div>
        <div>
          <button id="clear-chat-btn" onclick="clearAllChats()">Clear All Chats</button>
          <button id="reset-profile" onclick="resetProfile()">Change Profile</button>
        </div>
      </div>
      <ul id="messages"></ul>
      <div id="input-area">
        <input id="input" autocomplete="off" placeholder="Type a message..." />
        <input type="file" id="image-upload" accept="image/*" style="display:none;" />
        <button id="image-btn" onclick="document.getElementById('image-upload').click()">Photo</button>
        <button onclick="sendMessage()">Send</button>
        <div id="spam-toast">Don't spam!</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const socket = io('https://chat-randoms-backend.onrender.com');

    const ADMIN_SECRET = 'Admin-87a6d987asdt8yaguksdghfas7d';

    let myUsername = localStorage.getItem('chatUsername') || '';
    let myAvatarURL = localStorage.getItem('chatAvatarURL') || '';

    const nameScreen = document.getElementById('name-screen');
    const chat = document.getElementById('chat');
    const nameInput = document.getElementById('name');
    const avatarUrlInput = document.getElementById('avatar-url');
    const messages = document.getElementById('messages');
    const input = document.getElementById('input');
    const online = document.getElementById('online');
    const imageUpload = document.getElementById('image-upload');
    const clearChatBtn = document.getElementById('clear-chat-btn');
    const spamToast = document.getElementById('spam-toast');

    if (myUsername) autoJoin();

    function autoJoin() {
      socket.emit('join', { name: myUsername, avatarURL: myAvatarURL });
      nameScreen.style.display = 'none';
      chat.style.display = 'flex';
      checkAdmin();
    }

    function joinOrAuto() {
      const name = nameInput.value.trim();
      if (!name) return alert('Name required!');
      myUsername = name;
      myAvatarURL = avatarUrlInput.value.trim() || '';
      localStorage.setItem('chatUsername', myUsername);
      if (myAvatarURL) localStorage.setItem('chatAvatarURL', myAvatarURL);
      socket.emit('join', { name: myUsername, avatarURL: myAvatarURL });
      nameScreen.style.display = 'none';
      chat.style.display = 'flex';
      checkAdmin();
    }

    function checkAdmin() {
      clearChatBtn.style.display = (myUsername === ADMIN_SECRET) ? 'inline-block' : 'none';
    }

    function clearAllChats() {
      if (confirm('Clear chat for EVERYONE right now?')) {
        socket.emit('admin-clear-chat');
      }
    }

    socket.on('clear-chat', () => {
      messages.innerHTML = '';
      addSystemMessage('Chat cleared by admin');
      messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
    });

    function resetProfile() {
      localStorage.removeItem('chatUsername');
      localStorage.removeItem('chatAvatarURL');
      location.reload();
    }

    function showSpamWarning() {
      spamToast.classList.add('visible');
      setTimeout(() => spamToast.classList.remove('visible'), 2000);
    }

    function sendMessage() {
      const msg = input.value.trim();
      if (!msg) return;
      socket.emit('chat message', msg, (success) => {
        if (success) {
          input.value = '';
        } else {
          showSpamWarning();
        }
      });
    }

    imageUpload.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file || file.size > 2*1024*1024) return alert('Max 2MB');
      const reader = new FileReader();
      reader.onload = ev => {
        socket.emit('image', { buffer: ev.target.result, mime: file.type }, (success) => {
          if (!success) showSpamWarning();
        });
      };
      reader.readAsArrayBuffer(file);
    });

    input.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });

    function addSystemMessage(text) {
      const li = document.createElement('li');
      li.className = 'system';
      li.textContent = text;
      messages.appendChild(li);
    }

    function shouldAutoScroll() {
      return (messages.scrollHeight - messages.scrollTop - messages.clientHeight) < 500;
    }

    function appendMessage(data, isHistory = false) {
      const li = document.createElement('li');
      if (data.username === myUsername) li.classList.add('me');

      if (data.system) {
        li.className = 'system';
        li.textContent = data.text;
      } else {
        const avatar = document.createElement('img');
        avatar.className = 'avatar';
        avatar.src = data.avatarURL || `https://via.placeholder.com/40/333/fff?text=${data.username[0]||'?'}`;
        avatar.onerror = () => avatar.src = 'https://via.placeholder.com/40/333/fff?text=?';
        li.appendChild(avatar);

        const content = document.createElement('div');
        content.className = 'content';
        content.innerHTML = `<span class="username">${data.username}</span> `;
        if (data.isImage) {
          const img = document.createElement('img');
          img.className = 'chat-img';
          img.src = `data:${data.mime};base64,${btoa(String.fromCharCode(...new Uint8Array(data.image)))}`;
          content.appendChild(img);
        } else {
          content.appendChild(document.createTextNode(data.text));
        }
        li.appendChild(content);

        if (data.username === myUsername && !data.isImage) {
          const del = document.createElement('button');
          del.className = 'delete-btn';
          del.textContent = 'Ã—';
          del.onclick = () => li.remove();
          li.appendChild(del);
        }
      }

      messages.appendChild(li);

      if (!isHistory || shouldAutoScroll()) {
        setTimeout(() => messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' }), isHistory ? 50 : 0);
      }
    }

    socket.on('message', appendMessage);
    socket.on('history', h => h.forEach(m => appendMessage(m, true)));
    socket.on('online', c => online.textContent = `Online: ${c}`);
  </script>
</body>
</html>
