<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ChatWithRandoms.com</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#111; color:#eee; height:100vh; overflow:hidden; }
    #container { width:100%; max-width:720px; height:100vh; background:#222; margin:0 auto; display:flex; flex-direction:column; }
    #name-screen { flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px; }
    #chat { flex:1; display:flex; flex-direction:column; display:none; }
    #header { background:#1a1a1a; padding:12px 16px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; font-size:14px; }
    #messages { flex:1; list-style:none; padding:15px; margin:0; overflow-y:auto; background:#000; scroll-behavior: smooth; }
    #messages li { display:flex; align-items:flex-start; margin:10px 0; padding:10px 14px; border-radius:12px; background:#333; max-width:85%; word-wrap:break-word; }
    #messages li.me { margin-left:auto; background:#007bff; color:white; }
    #messages .avatar { width:38px; height:38px; border-radius:50%; margin-right:10px; object-fit:cover; flex-shrink:0; border:2px solid #555; }
    #messages .content { flex:1; line-height:1.4; }
    #messages .username { font-weight:bold; margin-right:6px; }
    #messages img.chat-img { max-width:260px; border-radius:8px; margin-top:6px; display:block; }
    #messages .delete-btn { background:none; border:none; color:#ff7777; font-size:20px; cursor:pointer; margin-left:8px; opacity:0.6; align-self:center; }
    #messages .delete-btn:hover { opacity:1; }
    #messages .system { margin:20px auto; width:fit-content; background:#444; color:#bbb; font-style:italic; padding:8px 18px; border-radius:20px; text-align:center; }
    #input-area { display:flex; padding:12px 16px; background:#1a1a1a; border-top:1px solid #333; gap:8px; }
    #input { flex:1; padding:12px 16px; border:none; border-radius:24px; background:#2a2a2a; color:#eee; font-size:16px; }
    #input:focus { outline:none; background:#333; }
    button { padding:12px 18px; background:#007bff; border:none; color:white; cursor:pointer; border-radius:24px; font-size:15px; white-space:nowrap; }
    #image-btn { background:#444; }
    #clear-chat-btn { background:#d32f2f; display:none; }
    #reset-profile { background:#555; font-size:13px; padding:8px 14px; }
    #online { color:#4caf50; font-weight:bold; }
    h1 { margin:0 0 20px 0; }
  </style>
</head>
<body>
  <div id="container">
    <div id="name-screen">
      <h1>ChatWithRandoms.com</h1>
      <p>Enter name + direct image URL (everyone sees your avatar)</p>
      <input id="name" type="text" placeholder="Your name..." style="padding:12px; width:280px; font-size:16px; margin:10px 0;" />
      <input id="avatar-url" type="text" placeholder="https://i.imgur.com/yourpic.jpg (optional)" style="padding:12px; width:280px; font-size:16px;" />
      <button onclick="joinOrAuto()" style="padding:14px 50px; font-size:18px; margin-top:20px;">Join / Continue</button>
    </div>

    <div id="chat">
      <div id="header">
        <div id="online">Online: 0</div>
        <div>
          <button id="clear-chat-btn" onclick="clearAllChats()">Clear All Chats</button>
          <button id="reset-profile" onclick="resetProfile()">Change Profile</button>
        </div>
      </div>
      <ul id="messages"></ul>
      <div id="input-area">
        <input id="input" autocomplete="off" placeholder="Type a message and hit Enter..." />
        <input type="file" id="image-upload" accept="image/*" style="display:none;" />
        <button id="image-btn" onclick="document.getElementById('image-upload').click()">ðŸ“·</button>
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const socket = io('https://chat-randoms-backend.onrender.com/');  // â† YOUR RENDER URL HERE

    const ADMIN_SECRET = 'Admin-87a6d987asdt8yaguksdghfas7d';

    let myUsername = localStorage.getItem('chatUsername') || '';
    let myAvatarURL = localStorage.getItem('chatAvatarURL') || '';

    const nameScreen = document.getElementById('name-screen');
    const chat = document.getElementById('chat');
    const nameInput = document.getElementById('name');
    const avatarUrlInput = document.getElementById('avatar-url');
    const messages = document.getElementById('messages');
    const input = document.getElementById('input');
    const online = document.getElementById('online');
    const imageUpload = document.getElementById('image-upload');
    const clearChatBtn = document.getElementById('clear-chat-btn');

    window.addEventListener('load', () => {
      if (myUsername) autoJoin();
    });

    function autoJoin() {
      socket.emit('join', { name: myUsername, avatarURL: myAvatarURL });
      nameScreen.style.display = 'none';
      chat.style.display = 'flex';
      checkAdmin();
    }

    function joinOrAuto() {
      const name = nameInput.value.trim();
      if (!name) return alert('Name required!');
      myUsername = name;
      myAvatarURL = avatarUrlInput.value.trim() || '';

      localStorage.setItem('chatUsername', myUsername);
      if (myAvatarURL) localStorage.setItem('chatAvatarURL', myAvatarURL);

      socket.emit('join', { name: myUsername, avatarURL: myAvatarURL });
      nameScreen.style.display = 'none';
      chat.style.display = 'flex';
      checkAdmin();
    }

    function checkAdmin() {
      clearChatBtn.style.display = (myUsername === ADMIN_SECRET) ? 'inline-block' : 'none';
    }

    function clearAllChats() {
      if (confirm('Clear entire chat for everyone?')) socket.emit('admin-clear-chat');
    }

    socket.on('clear-chat', () => {
      messages.innerHTML = '';
      const li = document.createElement('li');
      li.classList.add('system');
      li.textContent = 'Chat cleared by admin';
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;  // force to bottom after clear
    });

    function resetProfile() {
      localStorage.removeItem('chatUsername');
      localStorage.removeItem('chatAvatarURL');
      location.reload();
    }

    function sendMessage() {
      const msg = input.value.trim();
      if (msg) {
        socket.emit('chat message', msg);
        input.value = '';
      }
    }

    imageUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file || file.size > 2*1024*1024) return alert('Max 2MB image');
      const reader = new FileReader();
      reader.onload = (ev) => socket.emit('image', { buffer: ev.target.result, mime: file.type });
      reader.readAsArrayBuffer(file);
    });

    input.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

    function shouldAutoScroll() {
      const threshold = 320;  // pixels from bottom â€” increased to feel more natural
      return (messages.scrollHeight - messages.scrollTop - messages.clientHeight) < threshold;
    }

    function appendMessage(data, isHistory = false) {
      const li = document.createElement('li');
      if (data.username === myUsername) li.classList.add('me');

      if (data.system) {
        li.classList.add('system');
        li.textContent = data.text;
      } else {
        const avatar = document.createElement('img');
        avatar.classList.add('avatar');
        avatar.src = data.avatarURL || `https://via.placeholder.com/38?text=${data.username[0]||'?'}`;
        avatar.onerror = () => { avatar.src = 'https://via.placeholder.com/38?text=?'; };
        li.appendChild(avatar);

        const content = document.createElement('div');
        content.classList.add('content');
        content.innerHTML = `<span class="username">${data.username}</span> `;

        if (data.isImage) {
          const img = document.createElement('img');
          img.classList.add('chat-img');
          img.src = `data:${data.mime};base64,${arrayBufferToBase64(data.image)}`;
          content.appendChild(img);
        } else {
          content.appendChild(document.createTextNode(data.text));
        }
        li.appendChild(content);

        if (data.username === myUsername && !data.isImage) {
          const del = document.createElement('button');
          del.classList.add('delete-btn');
          del.textContent = 'Ã—';
          del.onclick = () => li.remove();
          li.appendChild(del);
        }
      }

      messages.appendChild(li);

      // Smarter scroll logic
      if (!isHistory || shouldAutoScroll()) {
        // Small delay helps when many messages load at once (history)
        setTimeout(() => {
          messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
        }, isHistory ? 100 : 0);
      }
    }

    socket.on('message', appendMessage);
    socket.on('history', history => {
      history.forEach(d => appendMessage(d, true));
      // Force scroll to bottom after full history load if was already at bottom
      if (shouldAutoScroll()) {
        messages.scrollTop = messages.scrollHeight;
      }
    });

    socket.on('online', count => online.textContent = `Online: ${count}`);

    function arrayBufferToBase64(buffer) {
      let binary = '';
      const bytes = new Uint8Array(buffer);
      for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return btoa(binary);
    }
  </script>
</body>
</html>
